/**
 * Teste espec√≠fico para debugar o problema do ROI
 * Este arquivo foca em identificar por que o ROI est√° aparecendo como 0,00%
 */

import { testSurebets } from './rankingTest.js'

// Fun√ß√£o para simular exatamente o que acontece no componente
export function debugROIProblem() {
  console.log('üîç DEBUG: Investigando problema do ROI...')
  console.log('=' .repeat(60))
  
  // Simular o estado inicial do componente
  let bookmakersStats = []
  let totalSurebets = 0
  let uniqueBookmakers = 0
  let totalProfit = 0
  let averageROI = 0
  
  console.log('üìä Estado inicial:')
  console.log(`   bookmakersStats: ${bookmakersStats.length} items`)
  console.log(`   totalSurebets: ${totalSurebets}`)
  console.log(`   uniqueBookmakers: ${uniqueBookmakers}`)
  console.log(`   totalProfit: ${totalProfit}`)
  console.log(`   averageROI: ${averageROI}`)
  
  console.log('')
  console.log('üîÑ Simulando processamento dos surebets...')
  
  // Simular o processamento exato do componente
  const bookmakerStats = {}
  
  testSurebets.forEach((surebet, index) => {
    console.log(`\nüîç Processando surebet ${index + 1}: ${surebet.id}`)
    console.log(`   Dados originais:`)
    console.log(`     bookmaker1: "${surebet.bookmaker1}"`)
    console.log(`     bookmaker2: "${surebet.bookmaker2}"`)
    console.log(`     profit: ${surebet.profit} (${typeof surebet.profit})`)
    console.log(`     roi: ${surebet.roi} (${typeof surebet.roi})`)
    
    // Processar bookmaker1
    if (surebet.bookmaker1) {
      const bookmaker = surebet.bookmaker1.trim()
      if (bookmaker) {
        if (!bookmakerStats[bookmaker]) {
          bookmakerStats[bookmaker] = {
            id: bookmaker.toLowerCase().replace(/\s+/g, '-'),
            name: bookmaker,
            count: 0,
            totalProfit: 0,
            totalROI: 0,
            surebets: []
          }
          console.log(`   ‚úÖ Criado novo bookmaker: ${bookmaker}`)
        }
        
        bookmakerStats[bookmaker].count++
        console.log(`   üìà Count atualizado para ${bookmaker}: ${bookmakerStats[bookmaker].count}`)
        
        // Verificar valores antes da valida√ß√£o
        console.log(`   üîç Valores antes da valida√ß√£o:`)
        console.log(`     profit original: ${surebet.profit} (${typeof surebet.profit})`)
        console.log(`     roi original: ${surebet.roi} (${typeof surebet.roi})`)
        
        // Garantir que os valores s√£o n√∫meros v√°lidos
        const validProfit = isNaN(surebet.profit) || surebet.profit === null || surebet.profit === undefined ? 0 : parseFloat(surebet.profit)
        const validROI = isNaN(surebet.roi) || surebet.roi === null || surebet.roi === undefined ? 0 : parseFloat(surebet.roi)
        
        console.log(`   ‚úÖ Valores ap√≥s valida√ß√£o:`)
        console.log(`     validProfit: ${validProfit} (${typeof validProfit})`)
        console.log(`     validROI: ${validROI} (${typeof validROI})`)
        
        // Verificar se a valida√ß√£o est√° funcionando
        if (validProfit !== surebet.profit) {
          console.log(`   ‚ö†Ô∏è ATEN√á√ÉO: profit foi alterado de ${surebet.profit} para ${validProfit}`)
        }
        if (validROI !== surebet.roi) {
          console.log(`   ‚ö†Ô∏è ATEN√á√ÉO: roi foi alterado de ${surebet.roi} para ${validROI}`)
        }
        
        bookmakerStats[bookmaker].totalProfit += validProfit
        bookmakerStats[bookmaker].totalROI += validROI
        bookmakerStats[bookmaker].surebets.push(surebet)
        
        console.log(`   üìä Totais acumulados para ${bookmaker}:`)
        console.log(`     totalProfit: ${bookmakerStats[bookmaker].totalProfit}`)
        console.log(`     totalROI: ${bookmakerStats[bookmaker].totalROI}`)
        
        // Calcular m√©dias
        bookmakerStats[bookmaker].averageProfit = bookmakerStats[bookmaker].count > 0 ? bookmakerStats[bookmaker].totalProfit / bookmakerStats[bookmaker].count : 0
        bookmakerStats[bookmaker].averageROI = bookmakerStats[bookmaker].count > 0 ? bookmakerStats[bookmaker].totalROI / bookmakerStats[bookmaker].count : 0
        
        console.log(`   üßÆ M√©dias calculadas para ${bookmaker}:`)
        console.log(`     averageProfit: ${bookmakerStats[bookmaker].averageProfit}`)
        console.log(`     averageROI: ${bookmakerStats[bookmaker].averageROI}`)
        
        // Verificar se as m√©dias s√£o v√°lidas
        if (isNaN(bookmakerStats[bookmaker].averageProfit) || bookmakerStats[bookmaker].averageProfit === Infinity || bookmakerStats[bookmaker].averageProfit === -Infinity) {
          console.log(`   ‚ö†Ô∏è PROBLEMA: averageProfit inv√°lido: ${bookmakerStats[bookmaker].averageProfit}`)
          bookmakerStats[bookmaker].averageProfit = 0
        }
        if (isNaN(bookmakerStats[bookmaker].averageROI) || bookmakerStats[bookmaker].averageROI === Infinity || bookmakerStats[bookmaker].averageROI === -Infinity) {
          console.log(`   ‚ö†Ô∏è PROBLEMA: averageROI inv√°lido: ${bookmakerStats[bookmaker].averageROI}`)
          bookmakerStats[bookmaker].averageROI = 0
        }
        
        console.log(`   ‚úÖ M√©dias finais para ${bookmaker}:`)
        console.log(`     averageProfit: ${bookmakerStats[bookmaker].averageProfit}`)
        console.log(`     averageROI: ${bookmakerStats[bookmaker].averageROI}`)
      }
    }
    
    // Processar bookmaker2 se existir
    if (surebet.bookmaker2 && surebet.bookmaker2.trim()) {
      const bookmaker = surebet.bookmaker2.trim()
      if (bookmaker) {
        if (!bookmakerStats[bookmaker]) {
          bookmakerStats[bookmaker] = {
            id: bookmaker.toLowerCase().replace(/\s+/g, '-'),
            name: bookmaker,
            count: 0,
            totalProfit: 0,
            totalROI: 0,
            surebets: []
          }
          console.log(`   ‚úÖ Criado novo bookmaker2: ${bookmaker}`)
        }
        
        bookmakerStats[bookmaker].count++
        
        // Garantir que os valores s√£o n√∫meros v√°lidos
        const validProfit = isNaN(surebet.profit) || surebet.profit === null || surebet.profit === undefined ? 0 : parseFloat(surebet.profit)
        const validROI = isNaN(surebet.roi) || surebet.roi === null || surebet.roi === undefined ? 0 : parseFloat(surebet.roi)
        
        bookmakerStats[bookmaker].totalProfit += validProfit
        bookmakerStats[bookmaker].totalROI += validROI
        bookmakerStats[bookmaker].surebets.push(surebet)
        
        // Calcular m√©dias
        bookmakerStats[bookmaker].averageProfit = bookmakerStats[bookmaker].count > 0 ? bookmakerStats[bookmaker].totalProfit / bookmakerStats[bookmaker].count : 0
        bookmakerStats[bookmaker].averageROI = bookmakerStats[bookmaker].count > 0 ? bookmakerStats[bookmaker].totalROI / bookmakerStats[bookmaker].count : 0
        
        // Verificar se as m√©dias s√£o v√°lidas
        if (isNaN(bookmakerStats[bookmaker].averageProfit) || bookmakerStats[bookmaker].averageProfit === Infinity || bookmakerStats[bookmaker].averageProfit === -Infinity) {
          bookmakerStats[bookmaker].averageProfit = 0
        }
        if (isNaN(bookmakerStats[bookmaker].averageROI) || bookmakerStats[bookmaker].averageROI === Infinity || bookmakerStats[bookmaker].averageROI === -Infinity) {
          bookmakerStats[bookmaker].averageROI = 0
        }
        
        console.log(`   üìä Estat√≠sticas para bookmaker2 ${bookmaker}:`)
        console.log(`     count: ${bookmakerStats[bookmaker].count}`)
        console.log(`     totalProfit: ${bookmakerStats[bookmaker].totalProfit}`)
        console.log(`     totalROI: ${bookmakerStats[bookmaker].totalROI}`)
        console.log(`     averageProfit: ${bookmakerStats[bookmaker].averageProfit}`)
        console.log(`     averageROI: ${bookmakerStats[bookmaker].averageROI}`)
      }
    }
  })
  
  console.log('\n' + '=' .repeat(60))
  console.log('üìä RESULTADOS FINAIS DO DEBUG:')
  console.log('=' .repeat(60))
  
  // Converter para array e ordenar
  const finalStats = Object.values(bookmakerStats).sort((a, b) => b.count - a.count)
  
  finalStats.forEach((stats, index) => {
    console.log(`\nüèÜ ${index + 1}¬∫ Lugar: ${stats.name}`)
    console.log(`   Count: ${stats.count}`)
    console.log(`   Total Profit: ${stats.totalProfit}`)
    console.log(`   Total ROI: ${stats.totalROI}`)
    console.log(`   Average Profit: ${stats.averageProfit}`)
    console.log(`   Average ROI: ${stats.averageROI}`)
    
    // Verificar se h√° problemas
    if (stats.averageROI === 0 && stats.totalROI > 0) {
      console.log(`   ‚ö†Ô∏è PROBLEMA IDENTIFICADO: averageROI √© 0 mas totalROI √© ${stats.totalROI}`)
    }
    
    if (stats.averageProfit === 0 && stats.totalProfit > 0) {
      console.log(`   ‚ö†Ô∏è PROBLEMA IDENTIFICADO: averageProfit √© 0 mas totalProfit √© ${stats.totalProfit}`)
    }
    
    // Testar formata√ß√£o
    const formattedROI = formatROI(stats.averageROI)
    const formattedProfit = formatCurrency(stats.averageProfit)
    
    console.log(`   Formata√ß√£o:`)
    console.log(`     ROI formatado: ${formattedROI}%`)
    console.log(`     Profit formatado: ${formattedProfit}`)
  })
  
  // Atualizar vari√°veis do componente
  bookmakersStats = finalStats
  totalSurebets = testSurebets.length
  uniqueBookmakers = finalStats.length
  totalProfit = finalStats.reduce((sum, stats) => sum + stats.totalProfit, 0)
  averageROI = finalStats.reduce((sum, stats) => sum + stats.totalROI, 0) / totalSurebets
  
  console.log('\n' + '=' .repeat(60))
  console.log('üìà ESTAT√çSTICAS GERAIS:')
  console.log('=' .repeat(60))
  console.log(`   Total Surebets: ${totalSurebets}`)
  console.log(`   Unique Bookmakers: ${uniqueBookmakers}`)
  console.log(`   Total Profit: ${totalProfit}`)
  console.log(`   Average ROI: ${averageROI}`)
  
  return {
    bookmakersStats: finalStats,
    totalSurebets,
    uniqueBookmakers,
    totalProfit,
    averageROI
  }
}

// Fun√ß√£o para testar especificamente a formata√ß√£o do ROI
export function testROIFormatting() {
  console.log('üß™ Testando especificamente a formata√ß√£o do ROI...')
  console.log('=' .repeat(60))
  
  const testValues = [
    { value: 3.2, expected: '3.20' },
    { value: 2.8, expected: '2.80' },
    { value: 4.1, expected: '4.10' },
    { value: 4.8, expected: '4.80' },
    { value: 3.5, expected: '3.50' },
    { value: 0, expected: '0.00' },
    { value: null, expected: '0.00' },
    { value: undefined, expected: '0.00' },
    { value: 'invalid', expected: '0.00' },
    { value: Infinity, expected: '0.00' },
    { value: -Infinity, expected: '0.00' }
  ]
  
  testValues.forEach(({ value, expected }) => {
    const result = formatROI(value)
    const status = result === expected ? '‚úÖ' : '‚ùå'
    console.log(`${status} Input: ${value} (${typeof value}) -> Output: ${result} | Expected: ${expected}`)
  })
  
  console.log('=' .repeat(60))
}

// Fun√ß√£o para testar o c√°lculo matem√°tico do ROI
export function testROICalculation() {
  console.log('üß™ Testando c√°lculos matem√°ticos do ROI...')
  console.log('=' .repeat(60))
  
  // Simular dados de um bookmaker
  const testCases = [
    {
      name: 'Bet365',
      surebets: [
        { roi: 3.2, profit: 15.50 },
        { roi: 2.8, profit: 12.80 },
        { roi: 3.5, profit: 16.75 }
      ]
    },
    {
      name: 'William Hill',
      surebets: [
        { roi: 4.1, profit: 18.20 }
      ]
    },
    {
      name: 'Betfair',
      surebets: [
        { roi: 4.8, profit: 22.10 },
        { roi: 4.3, profit: 19.80 }
      ]
    }
  ]
  
  testCases.forEach(testCase => {
    console.log(`\nüîç Testando ${testCase.name}:`)
    
    const totalROI = testCase.surebets.reduce((sum, surebet) => sum + surebet.roi, 0)
    const count = testCase.surebets.length
    const averageROI = count > 0 ? totalROI / count : 0
    
    console.log(`   Surebets: ${count}`)
    console.log(`   ROIs individuais: ${testCase.surebets.map(s => s.roi).join(', ')}`)
    console.log(`   Total ROI: ${totalROI}`)
    console.log(`   C√°lculo: ${totalROI} / ${count} = ${averageROI}`)
    console.log(`   Average ROI: ${averageROI}`)
    
    // Verificar se o c√°lculo est√° correto
    const expectedAverage = testCase.surebets.reduce((sum, surebet) => sum + surebet.roi, 0) / testCase.surebets.length
    const isCorrect = Math.abs(averageROI - expectedAverage) < 0.001
    
    console.log(`   ‚úÖ C√°lculo correto: ${isCorrect ? 'SIM' : 'N√ÉO'}`)
  })
  
  console.log('=' .repeat(60))
}

// Fun√ß√£o de formata√ß√£o do ROI (simulando a do componente)
function formatROI(value) {
  // Verificar se o valor √© v√°lido
  if (value === null || value === undefined || isNaN(value) || value === Infinity || value === -Infinity) {
    return '0.00'
  }
  
  // Converter para n√∫mero se for string
  const numValue = typeof value === 'string' ? parseFloat(value) : value
  
  // Verificar novamente se √© um n√∫mero v√°lido
  if (isNaN(numValue) || numValue === Infinity || numValue === -Infinity) {
    return '0.00'
  }
  
  return numValue.toFixed(2)
}

// Fun√ß√£o de formata√ß√£o de moeda (simulando a do componente)
function formatCurrency(value) {
  // Verificar se o valor √© v√°lido
  if (value === null || value === undefined || isNaN(value) || value === Infinity || value === -Infinity) {
    return 'R$ 0,00'
  }
  
  // Converter para n√∫mero se for string
  const numValue = typeof value === 'string' ? parseFloat(value) : value
  
  // Verificar novamente se √© um n√∫mero v√°lido
  if (isNaN(numValue) || numValue === Infinity || numValue === -Infinity) {
    return 'R$ 0,00'
  }
  
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(numValue)
}

// Fun√ß√£o principal para executar todos os testes de debug
export function runROIDebugTests() {
  console.log('üöÄ Iniciando testes de debug do ROI...')
  console.log('=' .repeat(80))
  
  // Teste 1: Debug completo do problema
  console.log('üß™ TESTE 1: Debug completo do problema do ROI')
  console.log('-' .repeat(50))
  const debugResults = debugROIProblem()
  
  console.log('\n' + '=' .repeat(80))
  
  // Teste 2: Formata√ß√£o do ROI
  console.log('üß™ TESTE 2: Formata√ß√£o do ROI')
  console.log('-' .repeat(50))
  testROIFormatting()
  
  console.log('\n' + '=' .repeat(80))
  
  // Teste 3: C√°lculos matem√°ticos
  console.log('üß™ TESTE 3: C√°lculos matem√°ticos do ROI')
  console.log('-' .repeat(50))
  testROICalculation()
  
  console.log('\n' + '=' .repeat(80))
  console.log('‚úÖ Todos os testes de debug conclu√≠dos!')
  
  return debugResults
}

// Exportar para uso em outros arquivos
export default {
  debugROIProblem,
  testROIFormatting,
  testROICalculation,
  runROIDebugTests
}
