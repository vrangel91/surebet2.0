<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Cron Jobs VIP</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #3a3a3a;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff88;
        }
        .test-content {
            font-family: monospace;
            font-size: 12px;
            background: #4a4a4a;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn.success { background: #28a745; }
        .btn.danger { background: #dc3545; }
        .btn.warning { background: #ffc107; color: #212529; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-running { background: #28a745; }
        .status-stopped { background: #dc3545; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Teste Cron Jobs VIP</h1>
        
        <div class="test-section">
            <div class="test-title">üìã Instru√ß√µes</div>
            <div class="test-content">
1. Abra o console do navegador (F12)
2. Navegue para a aplica√ß√£o e fa√ßa login como ADMIN
3. Copie o token de autentica√ß√£o do localStorage
4. Cole o token no campo abaixo
5. Teste as rotas dos Cron Jobs
6. Verifique as respostas no console e na tela
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üîë Token de Autentica√ß√£o</div>
            <div class="test-content">
Para obter o token:
1. Abra o DevTools (F12)
2. V√° para Application > Local Storage
3. Procure por 'authToken'
4. Copie o valor completo
            </div>
            <input type="text" id="authToken" placeholder="Cole o token aqui..." style="width: 100%; padding: 10px; margin: 10px 0; background: #4a4a4a; color: white; border: 1px solid #666; border-radius: 4px;">
            <button class="btn success" onclick="getTokenFromStorage()">üìã Pegar Token do Storage</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">‚öôÔ∏è Controles dos Cron Jobs</div>
            <button class="btn success" onclick="testCronStatus()">üìä Verificar Status</button>
            <button class="btn success" onclick="testInitializeCron()">üöÄ Inicializar Cron Jobs</button>
            <button class="btn danger" onclick="testStopCron()">üõë Parar Cron Jobs</button>
            <button class="btn warning" onclick="testProcessExpired()">üîÑ Processar VIPs Expirados</button>
            <button class="btn warning" onclick="testWeeklyReport()">üìà Gerar Relat√≥rio Semanal</button>
        </div>
        
        <div class="test-section">
            <div class="test-title">üìä Status Atual</div>
            <div class="test-content" id="currentStatus">
                Aguardando teste...
            </div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üîç Logs de Debug</div>
            <div class="test-content" id="debugLogs">
                Aguardando logs...
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const logsContent = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '5px';
            logEntry.style.fontSize = '11px';
            
            let color = '#cccccc';
            if (type === 'error') color = '#ff4444';
            if (type === 'success') color = '#00ff88';
            if (type === 'warning') color = '#ffa500';
            
            logEntry.innerHTML = `<span style="color: ${color}">[${timestamp}] ${message}</span>`;
            logsContent.appendChild(logEntry);
            logsContent.scrollTop = logsContent.scrollHeight;
        }
        
        // Fun√ß√£o para pegar token do localStorage
        function getTokenFromStorage() {
            try {
                const token = localStorage.getItem('authToken');
                if (token) {
                    document.getElementById('authToken').value = token;
                    addLog('‚úÖ Token copiado do localStorage', 'success');
                    addLog(`üîë Token: ${token.substring(0, 50)}...`, 'info');
                } else {
                    addLog('‚ùå Nenhum token encontrado no localStorage', 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao pegar token: ${error.message}`, 'error');
            }
        }
        
        // Fun√ß√£o para fazer requisi√ß√µes autenticadas
        async function makeAuthenticatedRequest(url, method = 'GET', body = null) {
            const token = document.getElementById('authToken').value.trim();
            
            if (!token) {
                addLog('‚ùå Por favor, insira um token de autentica√ß√£o', 'error');
                return null;
            }
            
            const options = {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body && method !== 'GET') {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(url, options);
                const data = await response.json();
                
                return { response, data };
            } catch (error) {
                addLog(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
                return null;
            }
        }
        
        // Testar status dos cron jobs
        async function testCronStatus() {
            addLog('üìä Verificando status dos cron jobs...', 'info');
            
            const result = await makeAuthenticatedRequest('/api/vip/cron/status');
            if (!result) return;
            
            const { response, data } = result;
            
            if (response.ok) {
                addLog('‚úÖ Status dos cron jobs obtido com sucesso!', 'success');
                addLog(`üìä Resposta: ${JSON.stringify(data, null, 2)}`, 'info');
                
                // Atualizar status na tela
                updateStatusDisplay(data);
            } else {
                addLog(`‚ùå Erro ao obter status: ${response.status} ${response.statusText}`, 'error');
                addLog(`üìã Detalhes: ${JSON.stringify(data, null, 2)}`, 'error');
            }
        }
        
        // Testar inicializa√ß√£o dos cron jobs
        async function testInitializeCron() {
            addLog('üöÄ Inicializando cron jobs...', 'info');
            
            const result = await makeAuthenticatedRequest('/api/vip/cron/initialize', 'POST');
            if (!result) return;
            
            const { response, data } = result;
            
            if (response.ok) {
                addLog('‚úÖ Cron jobs inicializados com sucesso!', 'success');
                addLog(`üìä Resposta: ${JSON.stringify(data, null, 2)}`, 'info');
                
                // Atualizar status
                setTimeout(testCronStatus, 1000);
            } else {
                addLog(`‚ùå Erro ao inicializar cron jobs: ${response.status} ${response.statusText}`, 'error');
                addLog(`üìã Detalhes: ${JSON.stringify(data, null, 2)}`, 'error');
            }
        }
        
        // Testar parada dos cron jobs
        async function testStopCron() {
            addLog('üõë Parando cron jobs...', 'info');
            
            const result = await makeAuthenticatedRequest('/api/vip/cron/stop', 'POST');
            if (!result) return;
            
            const { response, data } = result;
            
            if (response.ok) {
                addLog('‚úÖ Cron jobs parados com sucesso!', 'success');
                addLog(`üìä Resposta: ${JSON.stringify(data, null, 2)}`, 'info');
                
                // Atualizar status
                setTimeout(testCronStatus, 1000);
            } else {
                addLog(`‚ùå Erro ao parar cron jobs: ${response.status} ${response.statusText}`, 'error');
                addLog(`üìã Detalhes: ${JSON.stringify(data, null, 2)}`, 'error');
            }
        }
        
        // Testar processamento de VIPs expirados
        async function testProcessExpired() {
            addLog('üîÑ Processando VIPs expirados...', 'info');
            
            const result = await makeAuthenticatedRequest('/api/vip/cron/process-expired', 'POST');
            if (!result) return;
            
            const { response, data } = result;
            
            if (response.ok) {
                addLog('‚úÖ VIPs expirados processados com sucesso!', 'success');
                addLog(`üìä Resposta: ${JSON.stringify(data, null, 2)}`, 'info');
            } else {
                addLog(`‚ùå Erro ao processar VIPs expirados: ${response.status} ${response.statusText}`, 'error');
                addLog(`üìã Detalhes: ${JSON.stringify(data, null, 2)}`, 'error');
            }
        }
        
        // Testar gera√ß√£o de relat√≥rio semanal
        async function testWeeklyReport() {
            addLog('üìà Gerando relat√≥rio semanal...', 'info');
            
            const result = await makeAuthenticatedRequest('/api/vip/cron/weekly-report', 'POST');
            if (!result) return;
            
            const { response, data } = result;
            
            if (response.ok) {
                addLog('‚úÖ Relat√≥rio semanal gerado com sucesso!', 'success');
                addLog(`üìä Resposta: ${JSON.stringify(data, null, 2)}`, 'info');
            } else {
                addLog(`‚ùå Erro ao gerar relat√≥rio semanal: ${response.status} ${response.statusText}`, 'error');
                addLog(`üìã Detalhes: ${JSON.stringify(data, null, 2)}`, 'error');
            }
        }
        
        // Atualizar exibi√ß√£o do status
        function updateStatusDisplay(data) {
            const statusContent = document.getElementById('currentStatus');
            
            if (data.status) {
                const status = data.status;
                statusContent.innerHTML = `
Status: <span class="status-indicator ${status.isRunning ? 'status-running' : 'status-stopped'}"></span>${status.isRunning ? 'Executando' : 'Parado'}
Inicializado: ${status.initialized ? 'Sim' : 'N√£o'}
Total de Jobs: ${status.totalJobs || 0}
√öltima Execu√ß√£o: ${status.lastExecution ? new Date(status.lastExecution).toLocaleString('pt-BR') : 'N/A'}
Pr√≥xima Execu√ß√£o: ${status.nextExecution ? new Date(status.nextExecution).toLocaleString('pt-BR') : 'N/A'}

Jobs Ativos:
${Object.entries(status.jobs || {}).map(([name, job]) => 
  `- ${name}: ${job.running ? 'Ativo' : 'Parado'}`
).join('\n')}
                `;
            } else {
                statusContent.innerHTML = 'Nenhum status dispon√≠vel';
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Teste Cron Jobs VIP iniciado', 'success');
            addLog('üí° Fa√ßa login como ADMIN e use o bot√£o "Pegar Token do Storage"', 'info');
        });
    </script>
</body>
</html>
